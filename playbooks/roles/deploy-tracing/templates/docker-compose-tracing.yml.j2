version: '3.6'
services:
  jaeger:
    image: jaegertracing/all-in-one:{{ jaeger_version }}
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "9411:9411"
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
    deploy:
      labels:
        - "traefik.port=16686"
        - "traefik.backend=jaeger"
        - "traefik.frontend.rule=Host:jaeger.tracing.{{ domain_name }}"
        - "traefik.docker.network={{ docker_network_name }}"
      mode: replicated
      replicas: 1
    networks:
      - {{ docker_network_name }}

  collector:
    image: otel/opentelemetry-collector:{{ opentelemetry_collector_version }}
    command: ["--config=/conf/collector-config.yaml", "--log-level=DEBUG"]
    volumes:
      - "{{ volume_directory }}/tracing/collector/collector-config.yaml:/conf/collector-config.yaml"
    ports:
      - "9464:9464"
      - "55680:55680"
      - "55681:55681"
    depends_on:
      - jaeger-all-in-one
    deploy:
      labels:
        - "traefik.port=55681"
        - "traefik.backend=collector"
        - "traefik.frontend.rule=Host:collector.tracing.{{ domain_name }}"
        - "traefik.docker.network={{ docker_network_name }}"
      mode: replicated
      replicas: 1
    networks:
      - {{ docker_network_name }}

networks:
  {{ docker_network_name }}:
    external: true
    name: {{ docker_network_name }}